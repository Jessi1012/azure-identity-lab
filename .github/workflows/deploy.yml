name: Deploy to Azure

on:
  push:
    branches: 
      - main  # Auto-deploy on merge to main
      - feature/test-deployment  # Temporarily enable auto-deploy for testing
    paths: 
      - 'terraform/**'
      - 'kql-queries/**'
      - 'scripts/**'
      - '.github/workflows/**'  # Also trigger when workflow files change
  workflow_dispatch:  # Manual triggering still available
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: development
    
    env:
      TF_VAR_resource_group_name: "Identity-Lab-RG"
      TF_VAR_location: "eastus"
      TF_VAR_workspace_name: "identity-lab-logs-v2"
      TF_VAR_log_retention_days: "30"
      TF_VAR_teams_webhook_url: ${{ secrets.TF_VAR_TEAMS_WEBHOOK_URL || '' }}
      # Backend authentication for Service Principal
      ARM_CLIENT_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).clientId }}
      ARM_CLIENT_SECRET: ${{ fromJSON(secrets.AZURE_CREDENTIALS).clientSecret }}
      ARM_SUBSCRIPTION_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).subscriptionId }}
      ARM_TENANT_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).tenantId }}

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}  # JSON credentials from service principal

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: NUCLEAR OPTION - Delete Corrupted State (ONE TIME ONLY)
        working-directory: ./terraform
        run: |
          echo "ðŸ”¥ DELETING CORRUPTED STATE - This will force clean start"
          echo "After this deployment succeeds, remove this step from the workflow"
          
          # Delete the corrupted state file
          az storage blob delete \
            --account-name tfstateb54w9t \
            --container-name tfstate \
            --name terraform.tfstate \
            --auth-mode login \
            || echo "State already deleted or doesn't exist"
          
          # Reinitialize with fresh state
          terraform init -reconfigure
          
          echo "âœ… Fresh state created"

      - name: Import Existing Resources into Fresh State
        working-directory: ./terraform
        continue-on-error: true
        run: |
          echo "ðŸ“¥ Importing existing Azure resources into Terraform state..."
          
          # Import Log Analytics Workspace first (CRITICAL - must exist before Sentinel)
          WORKSPACE_EXISTS=$(az monitor log-analytics workspace show \
            --resource-group "$TF_VAR_resource_group_name" \
            --workspace-name "$TF_VAR_workspace_name" \
            2>&1 | grep -c "\"name\": \"$TF_VAR_workspace_name\"" || echo "0")
          
          if [ "$WORKSPACE_EXISTS" -gt 0 ]; then
            echo "âœ… Workspace found - importing..."
            WORKSPACE_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$TF_VAR_resource_group_name/providers/Microsoft.OperationalInsights/workspaces/$TF_VAR_workspace_name"
            terraform import azurerm_log_analytics_workspace.identity_logs "$WORKSPACE_ID" || echo "Workspace import failed"
          else
            echo "â­ï¸ Workspace not found - will be created by Terraform"
          fi
          
          # Check if Sentinel exists before importing
          SENTINEL_EXISTS=$(az rest --method GET \
            --url "https://management.azure.com/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$TF_VAR_resource_group_name/providers/Microsoft.OperationalInsights/workspaces/$TF_VAR_workspace_name/providers/Microsoft.SecurityInsights/onboardingStates/default?api-version=2023-02-01" \
            2>&1 | grep -c "\"name\": \"default\"" || echo "0")
          
          if [ "$SENTINEL_EXISTS" -gt 0 ]; then
            echo "âœ… Sentinel found - importing..."
            SENTINEL_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$TF_VAR_resource_group_name/providers/Microsoft.OperationalInsights/workspaces/$TF_VAR_workspace_name/providers/Microsoft.SecurityInsights/onboardingStates/default"
            terraform import azurerm_sentinel_log_analytics_workspace_onboarding.sentinel "$SENTINEL_ID" || echo "Sentinel import failed"
          else
            echo "â­ï¸ Sentinel not found - will be created by Terraform"
          fi
          
          # Import Key Vault (find by prefix)
          KV_NAME=$(az keyvault list --resource-group "$TF_VAR_resource_group_name" --query "[?starts_with(name, 'kv-identity-')].name" -o tsv | head -1)
          if [ -n "$KV_NAME" ]; then
            KV_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$TF_VAR_resource_group_name/providers/Microsoft.KeyVault/vaults/$KV_NAME"
            terraform import azurerm_key_vault.identity_vault "$KV_ID" || echo "Key Vault import failed"
            
            # Import Key Vault secret
            terraform import azurerm_key_vault_secret.teams_webhook "https://${KV_NAME}.vault.azure.net/secrets/teams-webhook-url" || echo "Secret not found"
          fi
          
          # Import Logic App
          LOGIC_APP_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$TF_VAR_resource_group_name/providers/Microsoft.Logic/workflows/identity-auto-remediate"
          terraform import azurerm_logic_app_workflow.auto_remediate "$LOGIC_APP_ID" || echo "Logic App not found"
          
          # Import Storage Account
          STORAGE_NAME=$(az storage account list --resource-group "$TF_VAR_resource_group_name" --query "[?starts_with(name, 'tfstate')].name" -o tsv | head -1)
          if [ -n "$STORAGE_NAME" ]; then
            STORAGE_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$TF_VAR_resource_group_name/providers/Microsoft.Storage/storageAccounts/$STORAGE_NAME"
            terraform import azurerm_storage_account.tfstate "$STORAGE_ID" || echo "Storage account import failed"
            terraform import azurerm_storage_container.tfstate "https://${STORAGE_NAME}.blob.core.windows.net/tfstate" || echo "Container import failed"
          fi
          
          echo "âœ… Import complete - some resources may need to be created fresh"

      - name: Grant Service Principal Key Vault Permissions
        continue-on-error: true
        run: |
          echo "ðŸ” Granting Key Vault RBAC permissions to service principal..."
          
          # Find Key Vault by prefix
          KV_NAME=$(az keyvault list --resource-group "${{ env.TF_VAR_resource_group_name }}" --query "[?starts_with(name, 'kv-identity-')].name" -o tsv | head -1)
          
          if [ -n "$KV_NAME" ]; then
            echo "Found Key Vault: $KV_NAME"
            
            # Get service principal object ID from credentials
            SP_OBJECT_ID=$(az ad sp show --id "${{ env.ARM_CLIENT_ID }}" --query "id" -o tsv)
            echo "Service Principal Object ID: $SP_OBJECT_ID"
            
            # Grant Key Vault Secrets Officer role
            az role assignment create \
              --assignee "$SP_OBJECT_ID" \
              --role "Key Vault Secrets Officer" \
              --scope "/subscriptions/${{ env.ARM_SUBSCRIPTION_ID }}/resourceGroups/${{ env.TF_VAR_resource_group_name }}/providers/Microsoft.KeyVault/vaults/$KV_NAME" \
              || echo "Role assignment already exists or failed"
            
            echo "âœ… Key Vault permissions granted (may need 1-2 minutes to propagate)"
            sleep 60
          else
            echo "â­ï¸ No Key Vault found - will be created by Terraform"
          fi

      - name: Delete ALL Existing Sentinel Alert Rules
        working-directory: ./terraform
        continue-on-error: true
        run: |
          echo "ðŸ—‘ï¸ Deleting ALL existing Sentinel alert rules (they have wrong workspace IDs)..."
          
          # Get all existing alert rules
          ALERT_RULES=$(az rest --method GET \
            --url "https://management.azure.com/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$TF_VAR_resource_group_name/providers/Microsoft.OperationalInsights/workspaces/$TF_VAR_workspace_name/providers/Microsoft.SecurityInsights/alertRules?api-version=2023-02-01" \
            --query "value[].name" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$ALERT_RULES" ]; then
            for RULE_NAME in $ALERT_RULES; do
              echo "  ðŸ—‘ï¸ Deleting: $RULE_NAME"
              az rest --method DELETE \
                --url "https://management.azure.com/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$TF_VAR_resource_group_name/providers/Microsoft.OperationalInsights/workspaces/$TF_VAR_workspace_name/providers/Microsoft.SecurityInsights/alertRules/${RULE_NAME}?api-version=2023-02-01" \
                || echo "Failed to delete $RULE_NAME"
              sleep 2
            done
            echo "âœ… All alert rules deleted"
          else
            echo "âœ… No alert rules to delete"
          fi

      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          echo "ðŸ“‹ Planning infrastructure changes..."
          terraform plan -out=tfplan -var="teams_webhook_url=${TF_VAR_teams_webhook_url}"

      - name: Security Scan (Trivy)
        uses: aquasecurity/trivy-action@0.18.0
        continue-on-error: true  # Don't fail workflow on Trivy findings
        with:
          scan-type: 'config'
          scan-ref: './terraform'
          trivyignores: 'terraform/.trivyignore'  # Use ignore file for acceptable findings
          exit-code: '1'  # Fail if HIGH/CRITICAL issues found

      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply tfplan
        # Terraform automatically loads terraform.tfvars if present, or uses TF_VAR_* env vars

      - name: Create Success Summary
        run: |
          echo "# âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "All resources deployed to Azure" >> $GITHUB_STEP_SUMMARY