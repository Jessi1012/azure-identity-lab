name: Scheduled Drift Detection

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  detect-drift:
    name: Check for Configuration Drift
    runs-on: ubuntu-latest
    
    env:
      TF_VAR_resource_group_name: "Identity-Lab-RG"
      TF_VAR_location: "eastus"
      TF_VAR_workspace_name: "identity-lab-logs-v2"
      TF_VAR_log_retention_days: "30"
      TF_VAR_teams_webhook_url: ""
      ARM_CLIENT_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).clientId }}
      ARM_CLIENT_SECRET: ${{ fromJSON(secrets.AZURE_CREDENTIALS).clientSecret }}
      ARM_SUBSCRIPTION_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).subscriptionId }}
      ARM_TENANT_ID: ${{ fromJSON(secrets.AZURE_CREDENTIALS).tenantId }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Sync State
        working-directory: ./terraform
        run: |
          chmod +x ../scripts/sync-state.sh
          bash ../scripts/sync-state.sh || true

      - name: Detect Drift
        id: plan
        working-directory: ./terraform
        run: |
          terraform plan -detailed-exitcode -out=drift.tfplan || EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ "$EXIT_CODE" == "0" ]; then
            echo "status=no_changes" >> $GITHUB_OUTPUT
          elif [ "$EXIT_CODE" == "2" ]; then
            echo "status=drift_detected" >> $GITHUB_OUTPUT
          else
            echo "status=error" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue on Drift
        if: steps.plan.outputs.status == 'drift_detected'
        uses: actions/github-script@v6
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ö†Ô∏è Configuration Drift Detected',
              body: `## Configuration Drift Alert
              
              Terraform detected differences between the desired state and actual Azure resources.
              
              **Detection Time:** ${new Date().toISOString()}
              **Workflow Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              ### Recommended Actions:
              1. Review the Terraform plan output in the workflow logs
              2. Investigate manual changes made in Azure Portal
              3. Either:
                 - Run deployment to reconcile state, or
                 - Update Terraform code to match intended changes
              
              ### Common Causes:
              - Manual changes in Azure Portal
              - Changes by other automation
              - Resource updates by Azure platform
              
              ---
              ü§ñ Auto-generated by drift detection workflow`,
              labels: ['infrastructure', 'drift-detection', 'needs-review']
            });
            
            console.log(\`Created issue #\${issue.data.number}\`);

      - name: Send Notification
        if: steps.plan.outputs.status == 'drift_detected' && secrets.TF_VAR_TEAMS_WEBHOOK_URL
        run: |
          curl -X POST "${{ secrets.TF_VAR_TEAMS_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "‚ö†Ô∏è Infrastructure Drift Detected",
              "text": "Configuration drift detected in Azure Sentinel Lab. Check GitHub Issues for details.",
              "themeColor": "FFA500"
            }'
